---
title: "Exploratory Data Analysis"
author: "David Fencsik"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GGally)
library(viridis)
dataFile="RSVPLG01-Data.RData"
```

# Load data files

```{r, loaddata1}
if(!file.exists(dataFile)) {
  sprintf("Cannot find file %s", dataFile)
  knitr::knit_exit()
}
```

```{r, loaddata2}
load(dataFile)
```

# Survey Distributions

Violin plots of the summed survey scores with quantile lines and the black X marking the mean, and individual subject scores marked by points and jittered.

```{r, surveydistr}
rsvpAggregate |>
  pivot_longer(bsam:promisd, names_to = "survey", values_to = "x") |>
  group_by(sub, survey) |>
  summarize(sum=max(x), .groups="drop") |>
  drop_na(sum) |> 
  ggplot(aes(factor(survey), sum, color=survey)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=.15) +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="black", shape="cross", size=5) +
  #scale_color_viridis(discrete=TRUE) +
  labs(x="Survey", y="Sum of responses")
```

# Survey Correlations

Check for correlations among the four surveys.

```{r, surveycorrelations1}
columns = c("bsam", "promisa", "promisd", "sias6")
rsvpAggregate |>
  select(all_of(columns)) |>
  drop_na(everything()) |>
  ggpairs()
```

Check for that one outlier in SIAS6...

```{r, surveycorrelations2}
rsvpAggregate |>
  arrange(sias6) |>
  tail(15)
```

...and the other outlier in PROMIS-A.

```{r, surveycorrelations2.5}
rsvpAggregate |>
  arrange(promisa) |>
  tail(15)
```

Rerun the correlations without the subject whose SIAS6 score of 23 is higher than everyone else (514).

```{r, surveycorrelations3}
rsvpAggregate |>
  filter(sias6 != 23 & promisa != 38) |>
  select(all_of(columns)) |>
  drop_na(everything()) |>
  ggpairs()
```

# Summaries of Accuracy

T1 Accuracy across the 12 cells

```{r, accuracysummaries1, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  unite("cell", t1_level, t2_level, t2_lag) |>
  ggplot(aes(factor(cell), t1acc)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=0, color="black", shape="circle open") +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="red", shape="cross", size=5)
```

Overall T2 accuracy across the 8 cells (not including T2 absent)

```{r, accuracysummaries2, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  filter(t2_lag > 0) |>
  unite("cell", t2_lag, t1_level, t2_level) |>
  ggplot(aes(factor(cell), t2acc)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=0, color="black", shape="circle open") +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="red", shape="cross", size=5)
```

T2|T1 accuracy across the 8 cells (not including T2 absent)

```{r, accuracysummaries3, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  filter(t2_lag > 0) |>
  drop_na(t2t1acc) |>
  unite("cell", t2_lag, t1_level, t2_level) |>
  ggplot(aes(factor(cell), t2t1acc)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=0, color="black", shape="circle open") +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="red", shape="cross", size=5)
```

# Effects of Anxiety on Attention Measures

Plot of various accuracies as a function of PROMIS-A.

```{r, attentionbyanxiety, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  drop_na(t2t1acc) |>
  filter(t2_lag > 0) |>
  unite("cell", t1_level, t2_level) |>
  ggplot(aes(x=promisa, y=t2t1acc, color=cell)) +
  geom_point() +
  geom_smooth(method="lm", formula=y~x, se=FALSE) +
  coord_cartesian(ylim = c(0.25, 0.75)) +
  facet_wrap(~t2_lag)

doModel = function(dat) lm(t2t1acc ~ promisa, dat)
getSlope = function(mod) coef(mod)[2]
getSig = function(mod) summary(mod)$coef[2, 4]
getRsq = function(mod) summary(mod)$r.squared

rsvpAggregate |>
  group_by(t2_lag, t1_level, t2_level) |>
  nest() |>
  mutate(model = map(data, doModel)) |>
  mutate(beta = map(model, getSlope),
         sig = map(model, getSig),
         r2 = map(model, getRsq)) |>
  select(!model) |>
  unnest(col=everything()) |>
  summarize(slope=mean(beta),
            p = mean(sig),
            rsq = mean(r2))
```
