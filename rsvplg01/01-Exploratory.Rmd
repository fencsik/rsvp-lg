---
title: "Exploratory Data Analysis"
author: "David Fencsik"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GGally)
library(viridis)
dataFile="RSVPLG01-Data.RData"
```

# Load data files

```{r, loaddata1}
if(!file.exists(dataFile)) {
  sprintf("Cannot find file %s", dataFile)
  knitr::knit_exit()
}
```

```{r, loaddata2}
load(dataFile)
```

Shorten "global" and "local" to "G" and "L", respectively.

```{r, shortenlabels}
rsvpAggregate = rsvpAggregate |>
  mutate(t1_level = toupper(substr(t1_level, 1, 1)),
         t2_level = toupper(substr(t2_level, 1, 1)))
```

# Survey Distributions

Violin plots of the summed survey scores with quantile lines and the black X marking the mean, and individual subject scores marked by points and jittered.

```{r, surveydistr}
rsvpAggregate |>
  pivot_longer(bsam:promisd, names_to = "survey", values_to = "x") |>
  group_by(sub, survey) |>
  summarize(sum=max(x), .groups="drop") |>
  drop_na(sum) |> 
  ggplot(aes(factor(survey), sum, color=survey)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=.15) +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="black", shape="cross", size=5) +
  #scale_color_viridis(discrete=TRUE) +
  labs(x="Survey", y="Sum of responses")
```

# Survey Correlations

Check for correlations among the four surveys.

```{r, surveycorrelations1}
columns = c("bsam", "promisa", "promisd", "sias6")
rsvpAggregate |>
  select(all_of(columns)) |>
  drop_na(everything()) |>
  ggpairs()
```

Check for that one outlier in SIAS6...

```{r, surveycorrelations2}
rsvpAggregate |>
  arrange(sias6) |>
  tail(15)
```

...and the other outlier in PROMIS-A.

```{r, surveycorrelations2.5}
rsvpAggregate |>
  arrange(promisa) |>
  tail(15)
```

# Summaries of Accuracy

Number of correct T1 responses in each condition to measure the number of trials going into calculations of T2|T1 accuracy.

```{r, lowT1acc1}
x = rsvpDataAnon |>
  filter(blocktyp == "Experiment" & trial_type == "exp") |>
  group_by(sub, t1_level, t2_level, t2_lag) |>
  summarize(numcor = sum(t1_acc), .groups="drop") |>
  ungroup()

x |>
  arrange(numcor) |>
  head(15)

cutoff = 5

x |>
  group_by(sub) |>
  summarize(nlowacc = sum(numcor < cutoff), .groups="drop") |>
  select(sub, nlowacc) |>
  arrange(nlowacc) |>
  tail(10)
```

Subjects with fewer than *cutoff* correct T1 responses in any of the conditions

```{r, lowT1acc2}
subsWithLowT1Acc = x |>
  filter(numcor < cutoff) |>
  select(sub) |>
  distinct()

subsWithLowT1Acc$sub
```

T1 Accuracy across the 12 cells

```{r, accuracysummaries1, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  unite("cell", t1_level, t2_level, t2_lag) |>
  ggplot(aes(factor(cell), t1acc)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=0, color="black", shape="circle open") +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="red", shape="cross", size=5)
```

Overall T2 accuracy across the 8 cells (not including T2 absent)

```{r, accuracysummaries2, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  filter(t2_lag > 0) |>
  unite("cell", t2_lag, t1_level, t2_level) |>
  ggplot(aes(factor(cell), t2acc)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=0, color="black", shape="circle open") +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="red", shape="cross", size=5)
```

T2|T1 accuracy across the 8 cells (not including T2 absent)

```{r, accuracysummaries3, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  filter(t2_lag > 0) |>
  drop_na(t2t1acc) |>
  unite("cell", t2_lag, t1_level, t2_level) |>
  ggplot(aes(factor(cell), t2t1acc)) +
  geom_violin(draw_quantiles=c(.25, .5, .75)) +
  geom_jitter(width=.15, height=0, color="black", shape="circle open") +
  theme(legend.position = "none") +
  stat_summary(fun=mean, geom="point", color="red", shape="cross", size=5)
```

# Effects of Anxiety on Attention Measures

Plot of various accuracies as a function of PROMIS-A.

```{r, attentionbyanxiety, fig.height=4.5, fig.width=11}
rsvpAggregate |>
  drop_na(t2t1acc) |>
  filter(t2_lag > 0) |>
  unite("cell", t1_level, t2_level) |>
  ggplot(aes(x=promisa, y=t2t1acc, color=cell)) +
  geom_point() +
  geom_smooth(method="lm", formula=y~x, se=FALSE) +
  coord_cartesian(ylim = c(0.25, 0.75)) +
  facet_wrap(~t2_lag)

doModel = function(dat) lm(t2t1acc ~ promisa, dat)
getSlope = function(mod) coef(mod)[2]
getSig = function(mod) summary(mod)$coef[2, 4]
getRsq = function(mod) summary(mod)$r.squared

rsvpAggregate |>
  group_by(t2_lag, t1_level, t2_level) |>
  nest() |>
  mutate(model = map(data, doModel)) |>
  mutate(beta = map(model, getSlope),
         sig = map(model, getSig),
         r2 = map(model, getRsq)) |>
  select(!model) |>
  unnest(col=everything()) |>
  summarize(slope=mean(beta),
            p = mean(sig),
            rsq = mean(r2))
```

# Random Analyses

T1 accuracy as a function of the letter. Letters E and S were much easier to detect locally than globally, and Z and to some Y and L were much easier to detect globally than locally. It looks like E was somewhat more frequently presented as the global letter than the local letter, at least for the first 88 subjects.

```{r, random1, fig.height=4.5, fig.width=11}
x = rsvpDataAnon |>
  filter(blocktyp == "Experiment" & trial_type == "exp") |>
  group_by(t1_level, t1) |>
  summarize(t1acc = mean(t1_acc), .groups="drop") |>
  ungroup()

x |>
  ggplot(mapping=aes(t1, t1acc, group=t1_level, fill=t1_level)) +
  coord_cartesian(ylim = c(0.5, 1.0)) +
  geom_col(position = "dodge")

y = x |>
  pivot_wider(names_from = t1_level, values_from = t1acc) |>
  mutate(local_adv = local - global)

y

y |>
  summarize(avg_local_adv = mean(local_adv),
            sum_local_adv = sum(local_adv))

x = rsvpDataAnon |>
  filter(blocktyp == "Experiment" & trial_type == "exp") |>
  group_by(t1_level, t1) |>
  summarize(freq = n(), .groups="drop") |>
  ungroup() |>
  pivot_wider(names_from = t1_level, values_from = freq) |>
  mutate(local_adv = local - global)

x

x |>
  summarize(gmean = mean(global),
            gsd = sqrt(var(global)),
            lmean = mean(local),
            lsd = sqrt(var(global)))
```
