---
title: "Prepare Data"
author: "David Fencsik"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# set variables to select from RSVP data file
variables = c(
  'exp',
  'ver',
  'mod.utc',
  'sub',
  'experimenter',
  'datetime',
  'blocktyp',
  'sess',
  'trial',
  'trial_type',
  'trial_time',
  't1_level',
  't2_level',
  't2_lag',
  'global_letters',
  'local_letters',
  't1_pos',
  't1',
  't1_corr',
  't1_resp',
  't1_acc',
  't2',
  't2_corr',
  't2_resp',
  't2_acc',
  't1_rt',
  't2_rt'
)
```

# Load Data Files

## Combine Individual RSVP Data Files

Gathers all the data files together, selecting a common set of headings

```{r loadrsvp}
testmode = TRUE
if (testmode) {
  dataDir = "/Users/fencsik/PsychoPy/RSVPLG/rsvplg01/data"
} else {
  dataDir = rstudioapi::selectDirectory(caption="Select RSVP Data Files Directory",
                                        label="Select",
                                        path=getwd())
}
source("gatherdata.r")
rsvpData = GatherData(dataDir, variables)
write.csv(rsvpData, sprintf("RSVPLG01-RawData-%s.csv", Sys.Date()),
          row.names=FALSE, quote=FALSE)
```

## Load Survey Data

Load the survey CSV file

```{r loadsurvey}
if (testmode) {
  surveyFile = "/Users/fencsik/PsychoPy/RSVPLG/rsvplg01/SurveyDataRaw.csv"
} else {
  surveyFile = rstudioapi::selectFile(caption="Select Survey Data File",
                                      label="Select",
                                      path=getwd(),
                                      filter="CSV Files (*.csv)",
                                      existing=TRUE)
}

if(!is.null(surveyFile)) {
  surveyData = read.csv(surveyFile)
}
```

# Clean Data

1. Remove incomplete data due to crashes

2. Correct subject ID typos

3. Removes minors

4. Recode gender to labeled factors

5. Create a common set of subjects across the two data sets


```{r cleandata}

# create new column names for survey data
names(surveyData) = tolower(names(surveyData))
surveyData$sub = surveyData$id

# remove data lines from a crash or empty survey responses
rsvpData = rsvpData[!is.na(rsvpData$sub), ]
surveyData = surveyData[!is.na(surveyData$sub), ]

# remove subjects w/ ID >= 900 (these were test runs)
rsvpData = rsvpData[rsvpData$sub < 900, ]
surveyData = surveyData[surveyData$sub < 900, ]

# correct subject ID typos
rsvpData$sub[with(rsvpData, sub == 317 & experimenter == "SN")] = 137
rsvpData$sub[with(rsvpData, sub == 514 & experimenter == "AGM")] = 154
surveyData$sub[with(surveyData, sub == 514 & startdate == "10/24/23 17:10")] = 154
rsvpData$sub[with(rsvpData, sub == 157 & experimenter == "ng")] = 156
surveyData$sub[with(surveyData, sub == 157 & startdate == "10/26/23 16:16")] = 156

# remove known minors
minors = c(106, 125, 126, 136, 145, 150, 214, 216, 217, 218)
rsvpData = rsvpData[!(rsvpData$sub %in% minors), ]
surveyData = surveyData[!(surveyData$sub %in% minors), ]

# check remaining subject ages in survey data
remainingMinors = !with(surveyData, age >= 18 | is.na(age))
if (any(remainingMinors)) {
  warning("survey data still has some minors:\n",
          paste(sort(unique(surveyData$sub[remainingMinors])), collapse=", "))
}

# recode gender (0->male, 1->female, 2->transmale, 3->transfemale, 4->nonbinary, 5->agender, 6->other)
surveyData$gender = factor(surveyData$gender, levels=as.character(0:6),
                           labels=c("male", "female", "transmale", "transfemale",
                                    "nonbinary", "agender", "other"))

# create a common set of subjects
subRSVP = sort(unique(rsvpData$sub))
subSurvey = sort(unique(surveyData$sub))
subCommon = intersect(subRSVP, subSurvey)
sprintf("Subjects in RSVP data set but not Survey data set: %s",
        paste(setdiff(subRSVP, subSurvey), collapse=", "))
sprintf("Subjects in Survey data set but not RSVP data set: %s",
        paste(setdiff(subSurvey, subRSVP), collapse=", "))
rsvpData = rsvpData[rsvpData$sub %in% subCommon, ]
surveyData = surveyData[surveyData$sub %in% subCommon, ]
```

# Randomize IDs

Generate randomly mapped subjet IDs and removes exp ID and run time for full anonymity

# Save Data