---
title: "Prepare Data"
author: "David Fencsik"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)

# set variables to select from RSVP data file
variables = c(
  'exp',
  'ver',
  'mod.utc',
  'sub',
  'experimenter',
  'datetime',
  'blocktyp',
  'sess',
  'trial',
  'trial_type',
  'trial_time',
  't1_level',
  't2_level',
  't2_lag',
  'global_letters',
  'local_letters',
  't1_pos',
  't1',
  't1_corr',
  't1_resp',
  't1_acc',
  't2',
  't2_corr',
  't2_resp',
  't2_acc',
  't1_rt',
  't2_rt'
)
```

# Purpose

Gather all the various RSVP data files and the survey data, do some basic cleaning and correction, then save them

# Load Data Files

## Combine Individual RSVP Data Files

Gathers all the data files together, selecting a common set of headings

```{r loadrsvp1}
testmode = FALSE
if (testmode) {
  dataDir = "data"
} else {
  dataDir = rstudioapi::selectDirectory(caption="Select RSVP Data Files Directory",
                                        label="Select",
                                        path=getwd())
}
if (is.null(dataDir)) {
  print("Canceled")
  knitr::knit_exit()
} else if (!dir.exists(dataDir)) {
  print(sprintf("Directory not found: %s", dataDir))
  knitr::knit_exit()
}
```

```{r loadrsvp2}
source("gatherdata.r")
rsvpData = GatherData(dataDir, variables)
sprintf("Gathered data files in %s together", dataDir)
sprintf("Data consists of %d rows and %d columns",
        dim(rsvpData)[1], dim(rsvpData)[2])
print("Columns:")
cat(sprintf("\"%s\"", paste(colnames(rsvpData), collapse="\", \"")))
write.csv(rsvpData, sprintf("RSVPLG01-RawData-%s.csv", Sys.Date()),
          row.names=FALSE)
print("Saved raw combined data for collaborators")
```

## Load Survey Data

Load the survey CSV file

```{r loadsurvey1}
if (testmode) {
  surveyFile = "SurveyDataRaw.csv"
} else {
  surveyFile = rstudioapi::selectFile(caption="Select Survey Data File",
                                      label="Select",
                                      path=getwd(),
                                      filter="CSV Files (*.csv)",
                                      existing=TRUE)
}
if(is.null(surveyFile)) {
  print("Cancelled")
  knitr::knit_exit()
} else if (!file.exists(surveyFile)) {
  print(sprintf("File not found: %s", surveyFile))
  knitr::knit_exit()
}
```

```{r loadsurvey2}
surveyData = read.csv(surveyFile)
sprintf("Loaded survey data file %s", surveyFile)
sprintf("Data consists of %d rows and %d columns",
        dim(surveyData)[1], dim(surveyData)[2])
print("Columns:")
cat(sprintf("\"%s\"", paste(colnames(surveyData), collapse="\", \"")))
```

# Clean Data

1. Lowercase and rename survey data columns

```{r cleandata1}
names(surveyData) = tolower(names(surveyData))
names(surveyData)[names(surveyData) == "id"] = "sub"
```

2. Remove data lines that have NA values from a crash or empty survey responses

```{r cleandata2}
rsvpData = rsvpData[!is.na(rsvpData$sub), ]
surveyData = surveyData[!is.na(surveyData$sub), ]
```

3. Remove test runs (Subjects w/ IDs >= 900)

```{r cleandata3}
rsvpData = rsvpData[rsvpData$sub < 900, ]
surveyData = surveyData[surveyData$sub < 900, ]
```

4. Correct subject ID typos

```{r cleandata4}
print("317 -> 137")
rsvpData$sub[with(rsvpData, sub == 317 & experimenter == "SN")] = 137
print("514 -> 154")
rsvpData$sub[with(rsvpData, sub == 514 & experimenter == "AGM")] = 154
surveyData$sub[with(surveyData, sub == 514 & startdate == "10/24/23 17:10")] = 154
print("One of the subjects labeled 157 -> 156")
rsvpData$sub[with(rsvpData, sub == 157 & experimenter == "ng")] = 156
surveyData$sub[with(surveyData, sub == 157 & startdate == "10/26/23 16:16")] = 156
```

5. Remove minors

```{r cleandata5}
nonminors = with(surveyData, is.na(age) | age >= 18)
if (any(!nonminors)) {
  print("Minors detected in data and will be removed:")
  print(sort(surveyData[!nonminors, "sub"]))
  surveyData = surveyData[nonminors, ]
  # these subjects will be removed automatically from the RSVP data set when we merge the two
} else {
  print("No minors detected in data")
}
```

6. Recode gender to labeled factors

```{r, cleandata6}
# recode gender (0->male, 1->female, 2->transmale, 3->transfemale, 4->nonbinary, 5->agender, 6->other)
surveyData$gender = factor(surveyData$gender, levels=as.character(0:6),
                           labels=c("male", "female", "transmale", "transfemale",
                                    "nonbinary", "agender", "other"))
```


7. Create a common set of subjects across the two data sets

```{r, cleandata7}
subRSVP = sort(unique(rsvpData$sub))
subSurvey = sort(unique(surveyData$sub))
subCommon = intersect(subRSVP, subSurvey)
sprintf("Subjects in RSVP data set but not Survey data set: %s",
        paste(setdiff(subRSVP, subSurvey), collapse=", "))
sprintf("Subjects in Survey data set but not RSVP data set: %s",
        paste(setdiff(subSurvey, subRSVP), collapse=", "))
rsvpData = rsvpData[rsvpData$sub %in% subCommon, ]
surveyData = surveyData[surveyData$sub %in% subCommon, ]
```

# Extract Fall 2023 PSYC 491C Dataset

Extract a data set with just the subjects run in my Fall 2023 PSYC 491C class so I can compare the statistics we computed in JASP with the same analyses in R.

```{r extract2023fa}
sub20239 = c(101, 103, 104, 105, 107, 108, 110, 111, 112, 113, 114, 115,
             116, 117, 118, 119, 120, 121, 122, 123, 127, 128, 129, 130,
             131, 132, 133, 134, 135, 137, 138, 139, 140, 141, 142, 143,
             144, 146, 147, 148, 149, 151, 152, 153, 154, 155, 156, 157,
             158, 160, 161, 162, 163, 164, 201, 202, 203, 204, 205, 206,
             207, 208, 209, 210, 211, 212, 213, 215, 217, 220, 221, 222)

rsvp20239 = rsvpData[rsvpData$sub %in% sub20239, ]
survey20239 = surveyData[surveyData$sub %in% sub20239, ]

save(rsvp20239, survey20239, file="RSVPLG01-20239-491C.RData")
```

# Anonymize Participants

Generate randomly mapped subject IDs to anonymize subjects

```{r anonymize1}
originalSubjects = sort(unique(rsvpData$sub))
n = length(originalSubjects)
newmin = 100
newmax = n * 2 + 100
mapper = data.frame(orig=originalSubjects,
                    new=sample(100:(100+n*2), n))
rsvpDataAnon = rsvpData
surveyDataAnon = surveyData
attach(mapper)
for (i in 1:n) {
  rsvpDataAnon$sub[rsvpData$sub == orig[i]] = new[i]
  surveyDataAnon$sub[surveyData$sub == orig[i]] = new[i]
}
detach(mapper)
```

Remove any columns that could be used to identify subjects

```{r anonymize2}
rsvpCols2Keep = c("exp", "ver", "sub", "experimenter", "blocktyp", "sess",
                  "trial", "trial_type", "t1_level", "t2_level", "t2_lag",
                  "global_letters", "local_letters", "t1_pos", "t1", "t1_corr",
                  "t1_resp", "t1_acc", "t2", "t2_corr", "t2_resp", "t2_acc",
                  "t1_rt", "t2_rt")
survCols2Keep = c("sub", "age", "gender",  "gender_6_text",
                  "bsam1", "bsam2", "bsam3", "bsam4", "bsam5", "bsam6",
                  "sias6_1", "sias6_2", "sias6_3", "sias6_4", "sias6_5", "sias6_6",
                  "promisd1", "promisd2", "promisd3", "promisd4", "promisd5",
                  "promisd6", "promisd7", "promisd8", "promisa1", "promisa2",
                  "promisa3", "promisa4", "promisa5", "promisa6", "promisa7",
                  "promisa8", "progress", "finished")
rsvpDataAnon = rsvpDataAnon[, rsvpCols2Keep]
surveyDataAnon = surveyDataAnon[, survCols2Keep]
```



# Save Data

Save anonymized data

```{r savedata}
save(rsvpDataAnon, surveyDataAnon, file="RSVPLG01-Data-Anon.RData")
```
